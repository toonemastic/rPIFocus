version: '3'
services:

  webapp:
    container_name: webapp
    image: toone/rpifocus-webapp:1.0.2
    restart: unless-stopped
    ports:
      - 4200:4200
    volumes:
      - db-gallery:/root/webapp/src/photos/gallery
      - db-raw:/root/webapp/src/photos/raw
    depends_on:
      - backend
    networks:
      - rpifocus

  backend:
    image: toone/rpifocus-backend:1.0.2
    container_name: backend
    restart: unless-stopped
    privileged: true
    environment:
      - LD_LIBRARY_PATH=/opt/vc/lib
      - HOST_M5STACK=192.168.1.36
      - HOST_OBJ_DETECTOR=obj-detector
      - PORT_OBJ_DETECTOR=8010
      - HOST_PHOTO_SERVICE=http://photo-service:8005
      - GALLERY_PATH=/mnt/gallery
    ports:
      - 5000:5000
    expose:
      - 5000
    volumes:
      - /opt/vc:/opt/vc
      - db-gallery:/mnt/gallery
      - db-raw:/mnt/raw
    devices:
      - /dev/vcsm:/dev/vcsm
      - /dev/vchiq:/dev/vchiq
      - /dev/video0:/dev/video0
    depends_on:
      - obj-detector
      - photo-service
    networks:
      - rpifocus

  obj-detector:
    image: toone/rpifocus-objdetector:1.0.2
    container_name: objdetector
    restart: unless-stopped
    privileged: true
    environment:
      - PORT_OBJ_DETECTOR=8010
      - MODEL_PATH=data/mobilenet_ssd_v2_coco_quant_postprocess_edgetpu.tflite
      - LABELS_PATH=data/coco_labels.txt
      - THRESHOLD=0.3
      - TOP_K=5
    expose:
      - 8010
    volumes:
      - /dev/bus/usb:/dev/bus/usb
    networks:
      - rpifocus

  photo-service:
    image: toone/rpifocus-photoservice:1.0.2
    container_name: photoservice
    restart: unless-stopped
    privileged: true
    environment:
      - LD_LIBRARY_PATH=/opt/vc/lib
      - PHOTO_TMP_PATH=/mnt/ramdisk
      - PHOTO_GALLERY_PATH=/mnt/gallery
      - PHOTO_RAW_PATH=/mnt/raw
      - HOST_REDIS=redis
      - PORT_RESTAPI=8005
    expose:
      - 8005
    volumes:
      - /opt/vc:/opt/vc
      - /mnt/ramdisk:/mnt/ramdisk
      - db-gallery:/mnt/gallery
      - db-raw:/mnt/raw
    devices:
      - /dev/vcsm:/dev/vcsm
      - /dev/vchiq:/dev/vchiq
      - /dev/video0:/dev/video0
    depends_on:
      - redis
    networks:
      - rpifocus

  redis:
    image: redis
    restart: unless-stopped
    container_name: redis
    expose:
      - 6379
    networks:
      - rpifocus

volumes:
  db-gallery:
  db-raw:

networks:
  rpifocus:
